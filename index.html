<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intranet â€“ Launcher</title>

  <!--
  =====================================
  INTRANET LAUNCHER â€“ SINGLE FILE APP 
  =====================================
  Purpose
  -------
  â€¢ A tiny, dependencyâ€‘free launcher page listing your internal tools with search, tag filters,
    favorites (stored in the browser), and basic online/offline checks.

  Quick Start (local)
  -------------------
  1) Put this HTML file anywhere and open it in a modern browser.
     - TIP: For best results (status checks and CORS), serve it over HTTP instead of file://
  2) Fast local server (Node):
     - If you have Node.js: run `npx http-server -p 8080` in the folder containing this file.
     - Then open http://localhost:8080
     The port can be changed as needed.

  Quick Start (Docker, static hosting)
  ------------------------------------
  explique seulement le docker compose (le fichier est pret a l'emploi):
  1) Put this HTML file anywhere and create a docker-compose.yml file (already provided).
  2) Inside Docker Desktop open the terminal and navigate to the folder containing both files.
  3) Run `docker-compose up -d` in the folder containing both files.


  Configure your services
  -----------------------
  â€¢ Edit SERVICE_LIST in the script section below. Fields:
      name (string)      â€“ Display name of the service
      url (string)       â€“ Full URL (http/https) the card links to
      icon (string)      â€“ Optional emoji or short text shown in the square icon
      tags (string[])    â€“ Optional list used for filtering (and quick discovery)
      category (string)  â€“ Optional group header; defaults to "Misc" if omitted
      health (string)    â€“ Optional health path (e.g., "/health"), appended to url for checks

  About status checks (important)
  -------------------------------
  â€¢ The page uses fetch() from the user's browser to ping each service.
  â€¢ By default we use mode: 'no-cors' so crossâ€‘origin requests will resolve as 'opaque'.
    - If a request resolves (even 'opaque'), we treat the service as Online.
    - If it times out or errors, we mark it Offline.
  â€¢ For more precise status (HTTP codes), host this launcher under the same origin as your services
    OR enable CORS on your services' health endpoints.

  Favorites
  ---------
  â€¢ Stored in localStorage under key 'intranet:favs'. They are perâ€‘browser and perâ€‘machine.

  Accessibility & UX
  ------------------
  â€¢ Buttons announce pressed state via aria-pressed. Search field is labeled.

  Customize look & feel
  ---------------------
  â€¢ Colors, spacing, and grid are controlled in CSS variables and classes. Adjust freely.

  =============================================================
  -->

  <style>
    :root{
      /* Theme colors (tweak freely) */
      --bg:#0b0d12; --card:#151922; --muted:#9cb29a; --text:#e5e7eb; --accent:#3144eb;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --hover:#1f2633; --tag:#1c2129;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}

    /* Sticky header with subtle glass blur */
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,13,18,.95),rgba(11,13,18,.7) 70%,transparent);backdrop-filter:blur(6px)}

    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(20px,3vw,28px)}
    .sub{color:var(--muted);font-size:14px}

    /* Controls row: search + action buttons */
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .search{flex:1;min-width:220px;display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid #2a3140;border-radius:12px;padding:10px 12px}
    .search input{all:unset;flex:1}
    .btn{border:1px solid #2a3140;background:var(--card);padding:10px 14px;border-radius:12px;color:var(--text);cursor:pointer}
    .btn:hover{background:var(--hover)}

    /* Tag bar */
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid #2a3140;color:var(--tag);cursor:pointer}
    .tag.active{border-color:var(--accent);color:#3144eb}

    /* Card grid */
    .grid{display:grid;grid-template-columns:repeat( auto-fill, minmax(300px,1fr));gap:14px;margin-top:16px}
    .card{position:relative;border:1px solid #2a3140;background:var(--card);border-radius:16px;padding:14px;transition:transform .1s ease, background .2s}
    .card:hover{transform:translateY(-2px);background:var(--hover)}
    .card a{color:inherit;text-decoration:none;display:block}

    /* Card content */
    .row{display:flex;gap:12px;align-items:center}
    .icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;font-size:22px;background:#0f1420;border:1px solid #2a3140}
    .name{font-weight:700}
    .url{font-size:12px;color:var(--muted);word-break:break-all}

    /* Card footer: tags + status */
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:11px;color:var(--muted);border:1px solid #2a3140;padding:4px 8px;border-radius:999px}
    .status{font-size:12px;display:flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted)}
    .ok{background:var(--ok)} .bad{background:var(--bad)} .warn{background:var(--warn)}

    /* Favorite star in corner */
    .favorite{position:absolute;top:10px;right:10px;border:none;background:transparent;color:#ffd166;cursor:pointer;font-size:18px}

    .section{margin-top:20px}
    .section h2{font-size:16px;color:#cbd5e1;margin:0 0 8px}

    footer{opacity:.7;color:var(--muted);font-size:12px;margin:26px 0 40px}
    .hidden{display:none}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Kantana Server</h1>
      <div class="sub">Find all internal tools â€¢ Favorites â˜… â€¢ Status monitor</div>
      <div class="controls">
        <!-- Search field: filters by name, URL, or tags (clientâ€‘side, no backend) -->
        <label class="search" aria-label="Search">
          <span>ðŸ”Ž</span>
          <input id="q" placeholder="Search by name, tags, URLâ€¦" />
          <button class="btn" id="clearBtn" title="Clear">âœ•</button>
        </label>

        <!-- Toggle favorites: stores user's choices in localStorage -->
        <button class="btn" id="onlyFavBtn" aria-pressed="false">Show my favorites</button>

        <!-- Re-run status checks for all visible cards (simply re-renders and re-pings) -->
        <button class="btn" id="checkAllBtn">Check all statuses</button>
      </div>

      <!-- Dynamic tag bar (autoâ€‘built from SERVICE_LIST tags) -->
      <div class="tags" id="tagBar"></div>
    </div>
  </header>

  <!-- Main content (the cards are rendered here) -->
  <main class="wrap" id="app"></main>

  <footer class="wrap">
    Tip: add/edit services in <code>SERVICE_LIST</code> below. For status checks, expose a fast endpoint
    (e.g., <code>/health</code>) returning HTTP 200.
  </footer>

<script>
  // =============================================================
  // 1) CONFIGURE YOUR SERVICES HERE
  //    Define each service you want to appear as a card in the grid.
  //    Use clear names and consistent categories to keep things tidy.
  // =============================================================
  /** @type {Array<{name:string,url:string,icon?:string,tags?:string[],category?:string,health?:string}>} */
  const SERVICE_LIST = [
    { name:"Wiki (Wiki.js)", url:"http://tools.cg.kantana.co.th:8001", icon:"ðŸ“„", tags:["Docs","Information"], category:"Documentation"},
    { name:"Ayon", url:"http://tools.cg.kantana.co.th:8002", icon:"ðŸŽžï¸", tags:["VFX","Pipeline"], category:"Tools"},
    { name:"Asset Library", url:"http://tools.cg.kantana.co.th:8003", icon:"ðŸ“š", tags:["Resources","3D"], category:"Tools"},
    { name:"Excalidraw (Under development)", url:"http://tools.cg.kantana.co.th:8004", icon:"âœï¸", tags:["Whiteboard","Collaborative"], category:"Tools"}
  ];

  // =============================================================
  // 2) TINY UTILITIES
  //    Minimal helpers to keep the code readable.
  // =============================================================
  const $ = sel => document.querySelector(sel);
  const create = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
  const slug = s => (s||"").toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');

  // Favorites (persisted per-browser)
  const FAV_KEY = 'intranet:favs';
  const getFavs = () => new Set(JSON.parse(localStorage.getItem(FAV_KEY)||'[]'));
  const setFavs = (s) => localStorage.setItem(FAV_KEY, JSON.stringify([...s]));

  // =============================================================
  // 3) RENDERING
  //    Build the tag bar, filter, group by category, and draw cards.
  // =============================================================
  let activeTag = null; // currently selected tag filter (string or null)
  let onlyFav = false;  // show only favorites when true
  let q = '';           // current search query

  function gatherTags(){
    // Collect a sorted, unique list of tags from all services
    const t = new Set();
    SERVICE_LIST.forEach(s => (s.tags||[]).forEach(x=>t.add(x)));
    return [...t].sort((a,b)=>a.localeCompare(b,'en'));
  }

  function renderTags(){
    // Build tag chips ("All" plus one for each distinct tag)
    const bar = $('#tagBar');
    bar.innerHTML = '';

    const allBtn = create('button',{className:`tag ${!activeTag?'active':''}`,textContent:'All'});
    allBtn.onclick=()=>{activeTag=null; render();};
    bar.appendChild(allBtn);

    gatherTags().forEach(t=>{
      const b = create('button',{className:`tag ${activeTag===t?'active':''}`,textContent:t});
      b.onclick=()=>{activeTag = activeTag===t?null:t; render();};
      bar.appendChild(b);
    });
  }

  function groupByCategory(items){
    // Group a list of services by their category (defaults to "Misc")
    const map = new Map();
    items.forEach(it=>{
      const key = it.category||'Misc';
      if(!map.has(key)) map.set(key,[]);
      map.get(key).push(it);
    });
    // Sort categories alphabetically
    return [...map.entries()].sort((a,b)=>a[0].localeCompare(b[0],'en'));
  }

  function render(){
    renderTags();
    const favs = getFavs();

    // Main filter predicate: favorites, tag, and text search
    const filter = s => {
      if (onlyFav && !favs.has(s.url)) return false;
      if (activeTag && !(s.tags||[]).includes(activeTag)) return false;
      if (!q) return true;
      const hay = slug([s.name,s.url,(s.tags||[]).join(' ')].join(' '));
      return hay.includes(slug(q));
    };

    const list = SERVICE_LIST.filter(filter);
    const app = $('#app'); app.innerHTML='';

    if(!list.length){
      app.innerHTML = '<p class="sub">No matching service.</p>';
      return;
    }

    // Draw sections (by category) and the card grid
    for(const [cat, items] of groupByCategory(list)){
      const section = create('section', {className:'section'});
      const h2 = create('h2',{textContent:cat});
      const grid = create('div',{className:'grid'});
      section.append(h2, grid);
      app.appendChild(section);

      items.forEach(svc=>{
        const card = create('div',{className:'card'});

        // Clickable area: opens in a new tab
        const a = create('a',{href:svc.url,target:'_blank',rel:'noopener noreferrer'});
        const row = create('div',{className:'row'});
        const icon = create('div',{className:'icon',innerText:svc.icon||'ðŸ”—'});
        const text = create('div');
        text.innerHTML = `<div class="name">${svc.name}</div><div class="url">${svc.url}</div>`;
        row.append(icon,text); a.appendChild(row); card.appendChild(a);

        // Favorite toggle (â˜…/â˜†)
        const favBtn = create('button',{className:'favorite',title:'Add to favorites',innerText: getFavs().has(svc.url)?'â˜…':'â˜†'});
        favBtn.onclick = (e)=>{
          e.preventDefault(); e.stopPropagation();
          const f = getFavs(); f.has(svc.url)?f.delete(svc.url):f.add(svc.url); setFavs(f);
          favBtn.innerText = f.has(svc.url)?'â˜…':'â˜†';
        };
        card.appendChild(favBtn);

        // Footer: chips (tags) + live status
        const meta = create('div',{className:'meta'});
        const chips = create('div',{className:'chips'});
        (svc.tags||[]).forEach(t=> chips.appendChild(create('span',{className:'chip',textContent:t})) );
        const status = create('div',{className:'status'});
        status.innerHTML = `<span class="dot" title="unknown"></span><span class="sub">Statusâ€¦</span>`;
        meta.append(chips,status); card.appendChild(meta);

        // Asynchronous status check (bestâ€‘effort)
        if (svc.health){
          // Prefer a dedicated health path if provided (e.g., /health)
          checkStatus(svc, status.querySelector('.dot'), status.querySelector('.sub'));
        } else {
          // Otherwise do a simple ping to the root URL (GET, noâ€‘cors)
          simplePing(svc.url, 3000).then(ok=>{
            const d=status.querySelector('.dot'); const t=status.querySelector('.sub');
            d.classList.add(ok?'ok':'bad'); t.textContent = ok? 'Online' : 'Offline';
          });
        }

        grid.appendChild(card);
      });
    }
  }

  // =============================================================
  // 4) STATUS / HEALTH CHECKS
  //    These functions try to determine if a service is reachable from the browser.
  //    They are intentionally permissive to work across domains (noâ€‘cors).
  // =============================================================
  async function checkStatus(svc, dotEl, textEl){
    // Build health URL by appending the health path to the base URL
    const url = new URL((svc.health||'/'), svc.url).toString();
    try{
      const res = await timedFetch(url, {method:'GET'}, 4000);
      // In 'no-cors', Response.type is 'opaque' and status cannot be read (status=0).
      // We treat an 'opaque' success as Online since the network request completed.
      if (res && (res.ok || res.type === 'opaque')){ dotEl.classList.add('ok'); textEl.textContent='Online'; }
      else if(res && res.status >= 500){ dotEl.classList.add('bad'); textEl.textContent='Server error'; }
      else { dotEl.classList.add('warn'); textEl.textContent=`${res ? res.status : 'Unknown'}`; }
    }catch(e){ dotEl.classList.add('bad'); textEl.textContent='Offline'; }
  }

  function timedFetch(resource, options={}, timeout=5000){
    // Add an AbortController so long requests are cut off
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), timeout);
    const opts = { ...options, signal: controller.signal, mode:'no-cors' };
    return fetch(resource, opts).finally(()=>clearTimeout(id));
  }

  function simplePing(url, timeout=3000){
    // Best effort probe using GET + noâ€‘cors.
    // If the fetch resolves (even as 'opaque'), we consider it reachable.
    return timedFetch(url, {method:'GET'}, timeout)
      .then(() => true)
      .catch(() => false);
  }

  // =============================================================
  // 5) UI CONTROLS (Search, Clear, Favorites toggle, Recheck)
  // =============================================================
  $('#q').addEventListener('input', (e)=>{ q=e.target.value; render(); });
  $('#clearBtn').onclick = ()=>{ $('#q').value=''; q=''; render(); };
  $('#onlyFavBtn').onclick = (e)=>{
    onlyFav = !onlyFav;
    e.currentTarget.setAttribute('aria-pressed', String(onlyFav));
    e.currentTarget.textContent = onlyFav? 'Show all' : 'Show my favorites';
    render();
  };
  $('#checkAllBtn').onclick = ()=>{ render(); };

  // Initial render on load
  render();
</script>
</body>
</html>
